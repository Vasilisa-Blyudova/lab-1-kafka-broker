networks:
  internal:
    internal: true
  public:

services:

  # --------------------- BROKERS ---------------------
  broker-1:
    image: bitnamilegacy/kafka:latest
    container_name: broker-1
    hostname: broker-1
    networks:
      - internal
      - public
    ports:
      - "9094:9094"   # External access from host
    environment:
      KAFKA_ENABLE_KRAFT: "yes"
      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_PROCESS_ROLES: broker,controller
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@broker-1:9093,2@broker-2:9093,3@broker-3:9093
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER

      # Указываем фиксированный cluster ID, чтобы все брокеры согласовывались
      KAFKA_CLUSTER_ID: "11111111-1111-1111-1111-111111111111"

      # Listeners
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://broker-1:9092,EXTERNAL://localhost:9094
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      # Replication & ISR
      KAFKA_CFG_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_CFG_MIN_INSYNC_REPLICAS: 2
      KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR: 2

      ALLOW_PLAINTEXT_LISTENER: "yes"

  broker-2:
    image: bitnamilegacy/kafka:latest
    container_name: broker-2
    hostname: broker-2
    networks:
      - internal
    environment:
      KAFKA_ENABLE_KRAFT: "yes"
      KAFKA_CFG_NODE_ID: 2
      KAFKA_CFG_PROCESS_ROLES: broker,controller
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@broker-1:9093,2@broker-2:9093,3@broker-3:9093
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER

      KAFKA_CLUSTER_ID: "11111111-1111-1111-1111-111111111111"

      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://broker-2:9092
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      KAFKA_CFG_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_CFG_MIN_INSYNC_REPLICAS: 2
      KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR: 2

      ALLOW_PLAINTEXT_LISTENER: "yes"

  broker-3:
    image: bitnamilegacy/kafka:latest
    container_name: broker-3
    hostname: broker-3
    networks:
      - internal
    environment:
      KAFKA_ENABLE_KRAFT: "yes"
      KAFKA_CFG_NODE_ID: 3
      KAFKA_CFG_PROCESS_ROLES: broker,controller
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@broker-1:9093,2@broker-2:9093,3@broker-3:9093
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER

      KAFKA_CLUSTER_ID: "11111111-1111-1111-1111-111111111111"

      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://broker-3:9092
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      KAFKA_CFG_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_CFG_MIN_INSYNC_REPLICAS: 2
      KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR: 2

      ALLOW_PLAINTEXT_LISTENER: "yes"

  # --------------------- INIT ---------------------
  init-brokers:
    image: bitnamilegacy/kafka:latest
    container_name: init-brokers
    depends_on:
      - broker-1
      - broker-2
      - broker-3
    networks:
      - internal
    volumes:
      - ./scripts/init_broker.sh:/init_broker.sh:ro
    entrypoint: ["/bin/bash", "/init_broker.sh"]

  # --------------------- DATA PRODUCER ---------------------
  data-producer:
    build:
      context: .
      dockerfile: services/data_producer/Dockerfile
    container_name: data-producer
    depends_on:
      - broker-1
      - broker-2
      - broker-3
    networks:
      - internal
    volumes:
      - ./data:/app/data:rw
    environment:
      BROKER_URL: "broker-1:9092,broker-2:9092,broker-3:9092"

  # --------------------- PREPROCESSOR ---------------------
  preprocessor:
    build:
      context: .
      dockerfile: services/preprocessor/Dockerfile
    container_name: preprocessor
    depends_on:
      - data-producer
    networks:
      - internal
    environment:
      BROKER_URL: "broker-1:9092,broker-2:9092,broker-3:9092"

  # --------------------- INFERENCE ---------------------
  inference:
    build:
      context: .
      dockerfile: services/inference/Dockerfile
    container_name: inference
    networks:
      - internal
    volumes:
      - ./model:/app/model:ro
    environment:
      BROKER_URL: "broker-1:9092,broker-2:9092,broker-3:9092"
      ENCODER_PATH: /app/model/encoder.joblib
      SCALER_PATH: /app/model/scaler.joblib
      CLASSIFIER_PATH: /app/model/classifier.joblib

  # --------------------- DASHBOARD ---------------------
  dashboard:
    build:
      context: .
      dockerfile: client/Dockerfile
    container_name: dashboard
    depends_on:
      - inference
    networks:
      - internal
      - public
    ports:
      - "8501:8501"
    environment:
      BROKER_URL: "broker-1:9092,broker-2:9092,broker-3:9092"
